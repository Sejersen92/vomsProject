<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <link rel="stylesheet" href="/style.css" />
    <!-- important default styles -->
    <style>
        /* We would like to be able to shrink the body, so that we can put ui outside the content area. */
        body {
            margin: 0;
            box-sizing: border-box;
            position: relative;
        }
    </style>
    <link rel="stylesheet" href="/css/EditablePageUI.css" />
</head>
<body data-bind="css: { showVersionHistory: showVersionHistory() }">
    <ul id="voms-tools" class="voms-menu voms-horizontal" data-bind="using: tools">
        <li>
            <button data-bind="click: insert">insert</button>
        </li>
        <li>
            <button data-bind="click: moveBlock">move?</button>
        </li>
        <li>
            <button data-bind="click: bold">bold</button>
        </li>
        <li>
            <button data-bind="click: insertContainer">group</button>
        </li>
        <li>
            <button data-bind="click: deleteBlock">delete</button>
        </li>
    </ul>
    <ul id="versionHistory" class="voms-menu" data-bind="foreach: versions">
        <li>
            <button data-bind="disable: $root.currentVersion() === id || $root.isDeleted(),
                               click: $root.getVersionFunction(id)">
                <div data-bind="text: saveDate"></div>
                <strong data-bind="text: $root.getTitle(id)"></strong>
            </button>
        </li>
    </ul>
    <button id="menu-button" data-bind="css: { 'voms-left': isMenuLeft() }, click: toggleMenu">Menu</button>
    <ul id="editor-menu" class="voms-menu" data-bind="css: { show: showMenu(), 'voms-left': isMenuLeft() }">
        <!-- ko if: isDeleted -->
        <li class="voms-notice">
            Current page is deleted
        </li>
        <!-- /ko -->
        <!-- ko if: hasBeenReplaced -->
        <li class="voms-notice">
            <p>It seems the page has already been replaced. If you still want to recover
            this page you have to delete the new one before you can. Otherwise you can just
            refresh this page to get to the new one.</p>
        </li>
        <!-- /ko -->
        <li class="voms-input">
            <label for="page-title">Page title</label>
            <input id="page-title" type="text" placeholder="Give your page a title" data-bind="textInput: title, disable: isDeleted" />
        </li>
        <li>
            <button data-bind="disable: (arePropertiesSaved() && isSaved() && isLatesVersion()) || isDeleted(),
                               attr: { title: isSaved() && isLatesVersion() ? 'Current page is saved' : '' },
                               click: save">
                Save
            </button>
        </li>
        <li>
            <button data-bind="disable: (isSaved() && isPublishedVersion()) || isDeleted(),
                               attr: { title: isSaved() && isPublishedVersion() ? 'Current page is published' : '' },
                               click: publish">
                Publish
            </button>
        </li>
        <li class="voms-hideable" data-bind="css: { show: isPublished() }, disable: isDeleted">
            <button data-bind="click: unpublish">Unpublish</button>
        </li>
        <li class="voms-hideable" data-bind="css: { show: isPublished() }">
            <button data-bind="disable: (isSaved() && isPublishedVersion()) || isDeleted(),
                               attr: { title: isSaved() && isPublishedVersion() ? 'Current page is published' : '' },
                               click: getPublishedVersion">
                <div>
                    Select published version
                </div>
                <small data-bind="text: publishedDate"></small>
            </button>
        </li>
        <li>
            <button data-bind="disable: (isSaved() && isLatesVersion()) || isDeleted(),
                               attr: { title: isSaved() && isLatesVersion() ? 'This is the last saved version' : '' },
                               click: getSavedVersion">
                <div>
                    Select last saved version
                </div>
                <small data-bind="text: savedDate"></small>
            </button>
        </li>
        <li>
            <button data-bind="text: showVersionHistory() ? 'Less Versions' : 'More Versions', click: toggleVersionHistory">More Versions</button>
        </li>
        <li class="voms-hideable" data-bind="css: { show: !isDeleted() }">
            <button data-bind="click: deletePage">
                <svg viewBox="0 0 115 170" xmlns="http://www.w3.org/2000/svg" fill="white" stroke="black" stroke-width="10">
                    <rect x="15" y="65" width="80" height="100" />
                    <rect x="05" y="25" width="100" height="20" />
                    <path d="M 35 20 V 05 h 40 V 20" fill="transparent" />
                    <line x1="35" x2="35" y1="80" y2="150" />
                    <line x1="55" x2="55" y1="80" y2="150" />
                    <line x1="75" x2="75" y1="80" y2="150" />
                </svg>
                Delete
            </button>
        </li>
        <li class="voms-hideable" data-bind="css: { show: isDeleted() }">
            <button data-bind="click: recoverPage">
                <svg style="transform: scale(1,-1)" viewBox="0 0 115 170" xmlns="http://www.w3.org/2000/svg" fill="white" stroke="black" stroke-width="10">
                    <rect x="15" y="65" width="80" height="100" />
                    <rect x="05" y="25" width="100" height="20" />
                    <path d="M 35 20 V 05 h 40 V 20" fill="transparent" />
                    <line x1="35" x2="35" y1="80" y2="150" />
                    <line x1="55" x2="55" y1="80" y2="150" />
                    <line x1="75" x2="75" y1="80" y2="150" />
                </svg>
                Recover
            </button>
        </li>
        <li>
            <!-- Use a form for logout, so that you can logout without javascript -->
            <form action="/Logout" method="post">
                <button>Logout</button>
            </form>
        </li>
        <li>
            <button data-bind="click: toggleMenuSide">
                <svg id="menu-side-arrow" viewBox="0 0 150 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M 0 10 L 17 0 V 8 H 150 v 4 H 17 V 20 Z" fill="black" />
                </svg>
                <span data-bind="text: isMenuLeft() ? 'Move Right' : 'Move Left' ">Move Left</span>
            </button>
        </li>
    </ul>
    <header>
        {{{ header }}}
    </header>
    <main id="page">
    </main>
    <footer>
        {{{ footer }}}
    </footer>
    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script src="/lib/knockout/knockout-3.5.1.js"></script>
    <script type="module">
        import {
            subscribe, unsubscribe, makeEditor, getContent, loadContent,
            makeBlock, deleteBlock, BlockType, moveBlock, makeSelectionBlod
        } from "/lib/Editor/voms-editor.js"
        ko.options.deferUpdates = true;
        var viewModel = {
            isSaved: ko.observable(true),
            arePropertiesSaved: ko.observable(true),
            title: ko.observable("{{ title }}"),
            savedVersion: ko.observable({{ savedVersion }}),
            savedDate: ko.observable("{{ savedDate }}"),
            currentVersion: ko.observable({{ savedVersion }}),
            isPublished: ko.observable({{ isPublished }}),
            publishedVersion: ko.observable({{ publishedVersion }}),
            publishedDate: ko.observable("{{ publishedDate }}"),
            showMenu: ko.observable(false),
            showVersionHistory: ko.observable(false),
            isMenuLeft: ko.observable(false),
            isDeleted: ko.observable(false),
            hasBeenReplaced: ko.observable(false),
            versions: ko.observableArray([
                // {{#versions}}
                {
                    id: {{ id }},
                    saveDate: "{{ saveDate }}"
                },
                // {{/versions}}
            ])
        };
        viewModel.title.subscribe(function () {
            viewModel.arePropertiesSaved(false);
        });

        // {{#isPublished}}
        viewModel.isPublished(true);
        // {{/isPublished}}
        viewModel.isLatesVersion = ko.pureComputed(function () {
            return viewModel.savedVersion() === viewModel.currentVersion();
        });
        viewModel.isPublishedVersion = ko.pureComputed(function () {
            return viewModel.publishedVersion() === viewModel.currentVersion();
        });
        viewModel.getTitle = function (id) {
            switch (id) {
                // A page can be both published and saved. If so the publish text takes priority.
                case viewModel.publishedVersion():
                    return "Published version";
                case viewModel.savedVersion():
                    return "Saved version";
            }
            return "";
        }

        // Toggle the main menu
        viewModel.toggleMenu = function () {
            viewModel.showMenu(!viewModel.showMenu());
        }

        // Toggle the version history menu
        viewModel.toggleVersionHistory = function () {
            viewModel.showVersionHistory(!viewModel.showVersionHistory());
        }

        // Toggle wich side the menu is on.
        viewModel.toggleMenuSide = function () {
            viewModel.isMenuLeft(!viewModel.isMenuLeft());
        }

        var page = document.getElementById("page");
        var editor = makeEditor(page);

        loadContent(editor, {{{ content }}});

        // Function bind to any change of the content. Set status to not saved.
        function onChange() {
            unsubscribe(editor, "block-order", onChange);
            unsubscribe(editor, "text-change", onChange);
            viewModel.isSaved(false);
        }

        // When entering a saved state add an event listener to changes.
        ko.computed(function () {
            if (viewModel.isSaved()) {
                subscribe(editor, "block-order", onChange);
                subscribe(editor, "text-change", onChange);
            }
        });

        // When title changes update page title.
        ko.computed(function () {
            document.title = viewModel.title();
        });

        // Stuff we need to do when the content is saved.
        // This is called after save (update, SetAsLastVersion and publish api calls)
        function whenSaved(saveResult) {
            viewModel.savedVersion(saveResult.latestVersion);
            viewModel.savedDate(saveResult.saveDate);
            viewModel.isSaved(true);
            viewModel.currentVersion(saveResult.latestVersion);
        }

        // Save the content.
        // If a different version has been picked but not changed, set it as the latest saved verison.
        viewModel.save = function () {
            if (!viewModel.isLatesVersion() && viewModel.isSaved()) {
                $.ajax({
                    type: "POST",
                    url: "/api/page/{{{ id }}}/SetAsLastVersion",
                    contentType: "application/json",
                    data: JSON.stringify({
                        versionId: viewModel.savedVersion()
                    }),
                    success: whenSaved
                });
            } else if (!viewModel.isSaved()) {
                $.ajax({
                    type: "POST",
                    url: "/api/page/{{{ id }}}/update",
                    contentType: "application/json",
                    data: JSON.stringify(getContent(editor)),
                    success: function (saveResult) {
                        whenSaved(saveResult);
                        viewModel.versions.push({
                            id: saveResult.latestVersion,
                            saveDate: saveResult.saveDate
                        });
                    }
                });
            }
            if (!viewModel.arePropertiesSaved()) {
                $.ajax({
                    type: "POST",
                    url: "/api/page/{{{ id }}}/properties/update",
                    contentType: "application/json",
                    data: JSON.stringify({
                        title: viewModel.title()
                    }),
                    success: function () {
                        viewModel.arePropertiesSaved(true);
                    }
                });
            }
        }

        // Publish and save the content.
        viewModel.publish = function () {
            $.ajax({
                type: "POST",
                url: "/api/page/{{{ id }}}/Publish",
                contentType: "application/json",
                data: JSON.stringify({
                    content: getContent(editor),
                    html: page.innerHTML
                }),
                success: function (saveResult) {
                    whenSaved(saveResult);
                    viewModel.publishedVersion(saveResult.latestVersion);
                    viewModel.publishedDate(saveResult.saveDate);
                    viewModel.isPublished(true);
                }
            });
        }

        // Set the published status to false.
        viewModel.unpublish = function () {
            $.ajax({
                type: "POST",
                url: "/api/page/{{{ id }}}/unpublish",
                success: function () {
                    viewModel.publishedVersion(null);
                    viewModel.isPublished(false);
                }
            });
        }

        // Load the version belonging by id.
        function getVersion(id) {
            if (viewModel.isSaved() && viewModel.currentVersion() !== id) {
                $.ajax({
                    type: "GET",
                    url: "/api/page/{{{ id }}}/Version/" + id,
                    contentType: "application/json",
                    success: function (content) {
                        viewModel.isSaved(true);
                        viewModel.currentVersion(content.id);

                        // Do not react to the change event while setting the content.

                        unsubscribe(editor, "block-order", onChange);
                        unsubscribe(editor, "text-change", onChange);
                        loadContent(editor, JSON.parse(content.content));
                        subscribe(editor, "block-order", onChange);
                        subscribe(editor, "text-change", onChange);
                    }
                });
            } else {
                console.log("Version '" + id + "' already selected.");
            }
        }

        // Mark the current page as deleted
        viewModel.deletePage = function () {
            $.ajax({
                type: "POST",
                url: "/api/page/{{{ id }}}/Delete",
                success: function () {
                    viewModel.isDeleted(true);
                }
            });
        }

        // Recover current page
        // This is only here in case the user instanly regrest deleting the page, 
        // as the otherwise would not be able to get to this page.
        viewModel.recoverPage = function () {
            $.ajax({
                type: "POST",
                url: "/api/page/{{{ id }}}/Recover",
                success: function() {
                    viewModel.isDeleted(false);
                    viewModel.hasBeenReplaced(false);
                },
                error: function (xhr) {
                    if (xhr.status == 409) {
                        viewModel.hasBeenReplaced(true);
                    }
                }
            });
        }

        // Return a function that will load a specific version.
        // id is the id of the version to load.
        viewModel.getVersionFunction = function (id) {
            return function () {
                getVersion(id);
            };
        }

        // Load the published version.
        viewModel.getPublishedVersion = function () {
            getVersion(viewModel.publishedVersion());
        }

        // Load the last saved version.
        viewModel.getSavedVersion = function () {
            getVersion(viewModel.savedVersion())
        }

        viewModel.tools = {
            insert: function () {
                var latest = makeBlock(editor.selectedBlock ? editor.selectedBlock.parent : editor, 0, BlockType.Text, "div");
                latest.element.focus();
            },
            // This is not the most ideal function for moving blocks.
            // it will move the selected text block in this way
            // into the next block if it is a container
            // past its next sibling if it has one
            // past its parent if that parent is not the root
            // as the first block of the root
            moveBlock: function() {
                var move = editor.selectedBlock;
                var index = move.parent.blocks.indexOf(move) + 1;
                var parent;
                if (move.parent.blocks.length === index) {
                    if (move.parent.parent != null) {
                        parent = move.parent.parent;
                        index = move.parent.parent.blocks.indexOf(move) + 1;
                    } else {
                        parent = move.parent;
                        index = 0;
                    }
                } else if (move.parent.blocks[index].type === BlockType.Container) {
                    parent = move.parent.blocks[index];
                } else {
                    parent = move.parent;
                }
                moveBlock(move, parent, index);
            },
            bold: makeSelectionBlod,
            insertContainer: function() {
                makeBlock(editor.selectedBlock.parent, 0, BlockType.Container, "div");
            },
            deleteBlock: function() {
                deleteBlock(editor.selectedBlock);
            }
        };

        ko.applyBindings(viewModel);
    </script>
</body>
</html>