<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <link rel="stylesheet" href="/style.css" />

    <!-- <link href="//cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"> snow theme is more intrusive -->
    <link href="//cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">

    <!-- Core build with no theme, formatting, non-essential modules -->
    <link href="//cdn.quilljs.com/1.3.6/quill.core.css" rel="stylesheet">
    <!-- important default styles -->
    <style>
        /* We would like to be able to shrink the body, so that we can put ui outside the content area. */
        body {
            margin: 0;
            box-sizing: border-box;
            position: relative;
        }
    </style>
    <style>
        #menu-button {
            box-sizing: border-box;
            position: absolute;
            right: 5rem;
            top: 5rem;
            width: 3.5em;
            height: 3.5em;
            border: 3px solid black;
            border-radius: 50%;
            background: white;
            z-index: 1;
        }
        #menu-button.voms-left {
            left: 5rem;

        }
            #menu-button:active {
                background: rgba(0,0,0,0.2)
            }
        #editor-menu {
            box-sizing: border-box;
            display: none;
            position: absolute;
            top: 9rem;
            right: 5rem;
            width: 13em;
        }
        #editor-menu.voms-left{
            left: 5rem;
        }
            #editor-menu.voms-left #menu-side-arrow {
                transform: scale(-1,1);
            }
            #editor-menu * {
                box-sizing: border-box;
            }
        .voms-menu {
            font-family: sans-serif;
            box-sizing: border-box;
            list-style: none;
            border: 3px solid black;
            padding: 0;
            background: white;
            margin: 0;
            z-index: 1;
        }
            .voms-menu * {
                box-sizing: border-box;
            }
            .voms-menu button {
                border: none;
                display: block;
                background: none;
                padding: 0.2em 0;
                width: 100%;
                padding: 0.5em;
            }
                .voms-menu button svg {
                    width: 5em;
                    height: auto;
                }
                .voms-menu button:active {
                    background: rgba(0,0,0,0.2)
                }
                .voms-menu input {
                    width: 100%;
                    border: 1px solid black;
                }
                .voms-menu li.voms-input {
                    padding: 0.2em;
                }
                .voms-menu li.voms-input input {
                    margin-top: 0.1em;
                    padding: 0.2em;
                }

                .voms-menu li + li {
                    border-top: 1px solid black;
                }
        #editor-menu.show {
            display: block;
        }
        .voms-hideable {
            display: none;
        }
            .voms-hideable.show {
                display: block;
            }
        body.showVersionHistory {
            width: calc(100% - 15rem);
        }
        .showVersionHistory #versionHistory {
            display: block;
        }
        #versionHistory {
            box-sizing: border-box;
            position: fixed;
            display: none;
            width: 15rem;
            right: 0;
            top: 0;
            max-height: 100vh;
            overflow: auto;
        }
        #versionHistory * {
            box-sizing: border-box;
        }

        @media (max-width: 720px) {
            #menu-button {
                top: 1rem;
                right: 1rem;
            }

                #menu-button.voms-left {
                    left: 1rem;
                }

            #editor-menu {
                box-sizing: border-box;
                top: 5rem;
                right: 0;
                max-width: 400px;
                width: 100vw;
            }

                #editor-menu.voms-left {
                    left: 0;
                }

            body.showVersionHistory {
                width: 100%;
            }

            #versionHistory {
                top: 5rem;
                max-height: calc(100vh - 5rem);
                max-width: 400px;
                width: 100vw;
            }
        }
    </style>
</head>
<body data-bind="css: { showVersionHistory: showVersionHistory() }">
    <ul id="versionHistory" class="voms-menu" data-bind="foreach: versions">
        <li>
            <button data-bind="disable: $root.currentVersion() === id,
                               click: getVersionFunction(id)">
                <div data-bind="text: saveDate"></div>
                <strong data-bind="text: getTitle(id)"></strong>
            </button>
        </li>
    </ul>
    <button id="menu-button" onclick="toggleMenu()" data-bind="css: { 'voms-left': isMenuLeft() }">Menu</button>
    <ul id="editor-menu" class="voms-menu" data-bind="css: { show: showMenu(), 'voms-left': isMenuLeft() }">
        <li class="voms-input">
            <label for="page-title">Page title</label>
            <input id="page-title" type="text" placeholder="Give your page a title" data-bind="textInput: title"/>
        </li>
        <li>
            <button onclick="save()" data-bind="disable: arePropertiesSaved() && isSaved() && isLatesVersion(),
                                                attr: { title: isSaved() && isLatesVersion() ? 'Current page is saved' : '' }">
                Save
            </button>
        </li>
        <li>
            <button onclick="publish()"
                    data-bind="disable: isSaved() && isPublishedVersion(),
                               attr: { title: isSaved() && isPublishedVersion() ? 'Current page is published' : '' }">
                Publish
            </button>
        </li>
        <li class="voms-hideable" data-bind="css: { show: isPublished() }">
            <button onclick="unpublish()">Unpublish</button>
        </li>
        <li class="voms-hideable" data-bind="css: { show: isPublished() }">
            <button onclick="getPublishedVersion()"
                    data-bind="disable: isSaved() && isPublishedVersion(),
                        attr: { title: isSaved() && isPublishedVersion() ? 'Current page is published' : '' }">
                <div>
                    Select published version
                </div>
                <small data-bind="text: publishedDate"></small>
            </button>
        </li>
        <li>
            <button onclick="getSavedVersion()"
                    data-bind="disable: isSaved() && isLatesVersion()
                               attr: { title: isSaved() && isLatesVersion() ? 'This is the last saved version' : '' }">
                <div>
                    Select last saved version
                </div>
                <small data-bind="text: savedDate"></small>
            </button>
        </li>
        <li>
            <button onclick="toggleVersionHistory()" data-bind="text: showVersionHistory() ? 'Less Versions' : 'More Versions'">More Versions</button>
        </li>
        <li>
            <!-- Use a form for logout, so that you can logout without javascript -->
            <form action="/Logout" method="post">
                <button>Logout</button>
            </form>
        </li>
        <li>
            <button onclick="toggleMenuSide()">
                <svg id="menu-side-arrow" viewBox="0 0 150 20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M 0 10 L 17 0 V 8 H 150 v 4 H 17 V 20 Z" fill="black" />
                </svg>
                <span data-bind="text: isMenuLeft() ? 'Move Right' : 'Move Left' ">Move Left</span>
            </button>
        </li>
    </ul>
    <header>
        {{{ header }}}
    </header>
    <main id="page">
    </main>
    <footer>
        {{{ footer }}}
    </footer>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="/lib/jquery/dist/jquery.min.js"></script>
    <script src="/lib/knockout/knockout-3.5.1.js"></script>
    <script>
        ko.options.deferUpdates = true;
        var viewModel = {
            isSaved: ko.observable(true),
            arePropertiesSaved: ko.observable(true),
            title: ko.observable("{{ title }}"),
            savedVersion: ko.observable({{ savedVersion }}),
            savedDate: ko.observable("{{ savedDate }}"),
            currentVersion: ko.observable({{ savedVersion }}),
            isPublished: ko.observable({{ isPublished }}),
            publishedVersion: ko.observable({{ publishedVersion }}),
            publishedDate: ko.observable("{{ publishedDate }}"),
            showMenu: ko.observable(false),
            showVersionHistory: ko.observable(false),
            isMenuLeft: ko.observable(false),
            versions: ko.observableArray([
                // {{#versions}}
                {
                    id: {{ id }},
                    saveDate: "{{ saveDate }}"
                },
                // {{/versions}}
            ])
        };
        viewModel.title.subscribe(function () {
            viewModel.arePropertiesSaved(false);
        });

        // {{#isPublished}}
        viewModel.isPublished(true);
        // {{/isPublished}}
        viewModel.isLatesVersion = ko.pureComputed(function () {
            return viewModel.savedVersion() === viewModel.currentVersion();
        });
        viewModel.isPublishedVersion = ko.pureComputed(function () {
            return viewModel.publishedVersion() === viewModel.currentVersion();
        });
        function getTitle(id) {
            switch (id) {
                // A page can be both published and saved. If so the publish text takes priority.
                case viewModel.publishedVersion():
                    return "Published version";
                case viewModel.savedVersion():
                    return "Saved version";
            }
            return "";
        }

        // Toggle the main menu
        function toggleMenu() {
            viewModel.showMenu(!viewModel.showMenu());
        }

        // Toggle the version history menu
        function toggleVersionHistory() {
            viewModel.showVersionHistory(!viewModel.showVersionHistory());
        }

        // Toggle wich side the menu is on.
        function toggleMenuSide() {
            viewModel.isMenuLeft(!viewModel.isMenuLeft());
        }

        var quill = new Quill('#page', {
            modules: {
                toolbar: [
                    [{ header: [1, 2, false] }],
                    ['bold', 'italic', 'underline'],
                    ['image', 'code-block']
                ]
            },
            placeholder: 'Write your article...',
            theme: 'bubble'
        });
        quill.setContents({{{ content }}});

        // Function bound to quill's text-change event. Set status to not saved.
        function onChange() {
            viewModel.isSaved(false);
        }

        // When entering a saved state add an event listener to changes.
        ko.computed(function () {
            if (viewModel.isSaved()) {
                quill.once("text-change", onChange);
            }
        });

        // When title changes update page title.
        ko.computed(function () {
            document.title = viewModel.title();
        });

        // Stuff we need to do when the content is saved.
        // This is called after save (update, SetAsLastVersion and publish api calls)
        function whenSaved(saveResult) {
            viewModel.savedVersion(saveResult.latestVersion);
            viewModel.savedDate(saveResult.saveDate);
            viewModel.isSaved(true);
            viewModel.currentVersion(saveResult.latestVersion);
            viewModel.versions.push({
                id: saveResult.latestVersion,
                saveDate: saveResult.saveDate
            });
        }

        // Save the content.
        // If a different version has been picked but not changed, set it as the latest saved verison.
        function save() {
            if (!viewModel.isLatesVersion() && viewModel.isSaved()) {
                $.ajax({
                    type: "POST",
                    url: "/api/page/{{{ id }}}/SetAsLastVersion",
                    contentType: "application/json",
                    data: JSON.stringify({
                        versionId: viewModel.savedVersion()
                    }),
                    success: whenSaved
                });
            } else if (!viewModel.isSaved()) {
                $.ajax({
                    type: "POST",
                    url: "/api/page/{{{ id }}}/update",
                    contentType: "application/json",
                    data: JSON.stringify(quill.getContents()),
                    success: whenSaved
                });
            }
            if (!viewModel.arePropertiesSaved()) {
                $.ajax({
                    type: "POST",
                    url: "/api/page/{{{ id }}}/properties/update",
                    contentType: "application/json",
                    data: JSON.stringify({
                        title: viewModel.title()
                    }),
                    success: function () {
                        viewModel.arePropertiesSaved(true);
                    }
                });
            }
        }

        // Publish and save the content.
        function publish() {
            $.ajax({
                type: "POST",
                url: "/api/page/{{{ id }}}/Publish",
                contentType: "application/json",
                data: JSON.stringify({
                    content: quill.getContents(),
                    html: quill.root.innerHTML
                }),
                success: function (saveResult) {
                    whenSaved(saveResult);
                    viewModel.publishedVersion(saveResult.latestVersion);
                    viewModel.publishedDate(saveResult.saveDate);
                    viewModel.isPublished(true);
                }
            });
        }

        // Set the published status to false.
        function unpublish() {
            $.ajax({
                type: "POST",
                url: "/api/page/{{{ id }}}/unpublish",
                success: function () {
                    viewModel.publishedVersion(null);
                    viewModel.isPublished(false);
                }
            });
        }

        // Load the version belonging by id.
        function getVersion(id) {
            if (viewModel.isSaved() && viewModel.currentVersion() !== id) {
                $.ajax({
                    type: "GET",
                    url: "/api/page/{{{ id }}}/Version/" + id,
                    contentType: "application/json",
                    success: function (content) {
                        viewModel.isSaved(true);
                        viewModel.currentVersion(content.id);

                        // Do not react to the change event while setting the content.
                        quill.off("text-change", onChange);
                        quill.setContents(JSON.parse(content.content));
                        quill.once("text-change", onChange);
                    }
                });
            } else {
                console.log("Version '" + id + "' already selected.");
            }
        }

        // Return a function that will load a specific version.
        // id is the id of the version to load.
        function getVersionFunction(id) {
            return function () {
                getVersion(id);
            };
        }

        // Load the published version.
        function getPublishedVersion() {
            getVersion(viewModel.publishedVersion());
        }

        // Load the last saved version.
        function getSavedVersion() {
            getVersion(viewModel.savedVersion())
        }

        ko.applyBindings(viewModel);
    </script>
</body>
</html>